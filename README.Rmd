---
title: "DS 2020 Final Project Report"
author: "David Wang, Logan Pappas"
date: "2025-11-30"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# load the data and library
library(tidyverse)

electric_vehicle_population_data <- read_csv("Electric_Vehicle_Population_Data.csv")

head(electric_vehicle_population_data)
glimpse(electric_vehicle_population_data)
dim(electric_vehicle_population_data)
```
Topic:
Differences in electric range across various vehicle makes,models, and location

How does electric range differ across vehicle makes?
How does electric range differ across models within the same make?
Do newer models within the same make tend to have higher range?
How does electric range differ between BEVs and PHEVs across makes?
Do average electric ranges differ across rural and urban cities?


```{r}
###cleaning to find median
electric_vehicle_population_data <- electric_vehicle_population_data %>%
  mutate(
    `Electric Range` = replace_na(`Electric Range`, median(`Electric Range`, na.rm = TRUE)),
    `Base MSRP` = replace_na(`Base MSRP`, median(`Base MSRP`, na.rm = TRUE))
  )

```

```{r}
#fixing data types
electric_vehicle_population_data <- electric_vehicle_population_data |>
  mutate(
    `Model Year` = as.integer(`Model Year`),
    `Postal Code` = as.character(`Postal Code`),
    `Legislative District` = as.factor(`Legislative District`),
    State = as.factor(State),
    `Electric Vehicle Type` = as.factor(`Electric Vehicle Type`),
    `Clean Alternative Fuel Vehicle (CAFV) Eligibility` =
      as.factor(`Clean Alternative Fuel Vehicle (CAFV) Eligibility`)
  )

#remove dupes
electric_vehicle_population_data <- electric_vehicle_population_data |>
  distinct(`VIN (1-10)`, `Model Year`, .keep_all = TRUE)

glimpse(electric_vehicle_population_data)

dim(electric_vehicle_population_data)
```

```{r}
library(tidyverse)
#we filter for vehicles that have electric range > 0 as we only care about electric cars
ev_plot <- electric_vehicle_population_data |>
  filter(!is.na(`Electric Range`), `Electric Range` > 0)

```


```{r}
#How does electric range differ across vehicle makes?

ev_plot |>
  ggplot(aes(x = reorder(Make, `Electric Range`, FUN = median),
             y = `Electric Range`)) +
  geom_boxplot() +
  coord_flip() +
  labs(
    title = "Electric Range Distribution by Vehicle Make",
    x = "Make",
    y = "Electric Range (miles)"
  )

ev_plot |>
  group_by(Make) |>
  summarise(
    mean_range = mean(`Electric Range`),
    sd_range = sd(`Electric Range`),
    .groups = "drop"
  ) |>
  ggplot(aes(x = reorder(Make, mean_range), y = mean_range)) +
  geom_point(size = 2) +
  geom_errorbar(aes(
    ymin = mean_range - sd_range,
    ymax = mean_range + sd_range
  ), width = 0.2) +
  coord_flip() +
  labs(
    title = "Average Electric Range by Make (±1 SD)",
    x = "Make",
    y = "Average Electric Range (miles)"
  )


```

```{r}
#How does electric range differ across models within the same make?
top_makes <- ev_plot |>
  count(Make, sort = TRUE) |>
  slice_head(n = 6) |>
  pull(Make)

ev_plot |>
  filter(Make %in% top_makes) |>
  ggplot(aes(
    x = `Electric Range`,
    y = interaction(Make, Model)
  )) +
  geom_boxplot() +
  facet_wrap(~ Make, scales = "free_y") +
  labs(
    title = "Electric Range by Model Within Top Vehicle Makes",
    x = "Electric Range (miles)",
    y = "Model"
  )


```

```{r}
#Do average electric ranges differ across rural and urban cities?
urban_rural_lookup <- tibble(
  City = c("Seattle", "Tacoma", "Spokane", "Bellevue", "Olympia",
           "Orondo", "Orondo", "Orting", "Palouse", "Port Hadlock"),
  Urban_Rural = c("Urban", "Urban", "Urban", "Urban", "Urban",
                  "Rural", "Rural", "Rural", "Rural", "Rural")
)
ev_city_classified <- electric_vehicle_population_data %>%
  left_join(urban_rural_lookup, by = "City")

ev_city_classified %>%
  filter(!is.na(Urban_Rural)) %>%
  group_by(Urban_Rural) %>%
  summarise(avg_range = mean(`Electric Range`, na.rm = TRUE)) %>%
  ggplot(aes(x = Urban_Rural, y = avg_range, fill = Urban_Rural)) +
  geom_col() +
  labs(
    title = "Average Electric Range: Urban vs Rural Cities",
    x = "City Type",
    y = "Average Range (miles)"
  ) +
  scale_fill_manual(values = c("Urban" = "steelblue", "Rural" = "forestgreen"))

ev_city_classified %>%
  filter(!is.na(Urban_Rural)) %>%
  group_by(City, Urban_Rural) %>%
  summarise(avg_range = mean(`Electric Range`, na.rm = TRUE)) %>%
  ggplot(aes(x = reorder(City, avg_range), y = avg_range, fill = Urban_Rural)) +
  geom_col() +
  coord_flip() +
  labs(
    title = "Average Electric Range of Selected Urban and Rural Cities",
    x = "City",
    y = "Average Electric Range"
  )
electric_vehicle_population_data %>%
  count(County) %>%
  arrange(desc(n)) %>%
  slice_head(n = 20) %>%   # top 20 counties
  ggplot(aes(x = reorder(County, n), y = n)) +
  geom_col(fill = "steelblue") +
  coord_flip() +
  labs(
    title = "Top 20 Counties by Number of Registered EVs",
    x = "County",
    y = "Number of EVs"
  ) +
  theme_minimal()
```
```{r}
#Do newer models within the same make tend to have higher range?

ev_plot |>
  filter(Make %in% top_makes) |>
  group_by(Make, `Model Year`) |>
  summarise(
    avg_range = mean(`Electric Range`),
    .groups = "drop"
  ) |>
  ggplot(aes(x = `Model Year`, y = avg_range, color = Make)) +
  geom_line() +
  geom_point() +
  labs(
    title = "Average Electric Range Over Time by Make",
    x = "Model Year",
    y = "Average Electric Range (miles)"
  )

```


```{r}
#How does electric range differ between BEVs and PHEVs across makes?
ev2 <- electric_vehicle_population_data %>%
  mutate(EV_Type = case_when(
    `Electric Vehicle Type` == "Battery Electric Vehicle (BEV)" ~ "BEV",
    `Electric Vehicle Type` == "Plug-in Hybrid Electric Vehicle (PHEV)" ~ "PHEV",
    TRUE ~ NA_character_
  ))

avg_range_by_type <- ev2 %>%
  filter(!is.na(EV_Type)) %>%
  group_by(EV_Type) %>%
  summarise(avg_range = mean(`Electric Range`, na.rm = TRUE))

p1 <- ggplot(avg_range_by_type,
             aes(x = EV_Type, y = avg_range, fill = EV_Type)) +
  geom_col() +
  scale_fill_manual(values = c("BEV" = "steelblue", "PHEV" = "darkorange")) +
  labs(
    title = "Average Electric Range: BEVs vs PHEVs",
    x = "Vehicle Type",
    y = "Average Electric Range (miles)"
  ) +
  theme_minimal()

top10_BEV <- ev2 %>%
  filter(EV_Type == "BEV") %>%
  count(Make, sort = TRUE) %>%
  slice_head(n = 10) %>%
  pull(Make)

top10_PHEV <- ev2 %>%
  filter(EV_Type == "PHEV") %>%
  count(Make, sort = TRUE) %>%
  slice_head(n = 10) %>%
  pull(Make)

range_top20 <- ev2 %>%
  filter(
    (EV_Type == "BEV" & Make %in% top10_BEV) |
    (EV_Type == "PHEV" & Make %in% top10_PHEV)
  ) %>%
  group_by(Make, EV_Type) %>%
  summarise(avg_range = mean(`Electric Range`, na.rm = TRUE)) %>%
  ungroup()

unique_levels <- unique(c(top10_BEV, top10_PHEV))

range_top20$Make <- factor(range_top20$Make, levels = unique_levels)

p2 <- ggplot(range_top20,
             aes(x = Make, y = avg_range, fill = EV_Type)) +
  geom_col(position = "dodge") +
  coord_flip() +
  labs(
    title = "Top 10 BEV vs Top 10 PHEV Makes — Average Electric Range",
    x = "Vehicle Make",
    y = "Average Electric Range (miles)",
    fill = "EV Type"
  ) +
  scale_fill_manual(values = c("BEV" = "steelblue", "PHEV" = "darkorange")) +
  theme_minimal()

p1
p2
```
